#!/usr/bin/env zsh

# Configuration
subsystem="xyz.hribar.nukelogi"
plist_loc="/Library/LaunchDaemons/${subsystem}.plist"
util="ServiceStart"

# Our own logging utility
LOG_BIN="/usr/local/bin/nukelog"

# --- FUNCTION: Log Event ---
log_event() {
  local msg="${1}"
  local timestamp

  # 1. Get the timestamp
  if (( $+commands[gdate] )); then
    timestamp=$(gdate '+%Y-%m-%d %H:%M:%S.%6N')
  else
    timestamp=$(date '+%Y-%m-%d %H:%M:%S')
  fi

  # 2. Print to standard out (for debug/console logs)
  echo "[${timestamp}] ${subsystem} ${util:-Service} [PPID:${$}] ${msg}"

  # 3. Call the logging utility
  if [[ -x "${LOG_BIN}" ]]; then
    "${LOG_BIN}" "${subsystem}" "${util:-Service}" "[PPID:${$}] ${msg}"
  fi
}

# --- MAIN EXECUTION ---
if [[ ! -f "${plist_loc}" ]]; then
  log_event "❌ Error: Missing configuration '${plist_loc}'."
  exit 1
fi

# 1. Ask for password upfront
sudo -v

# 2. Load the service back into the system
log_event "Loading service '${subsystem}'..."
if ! sudo launchctl bootstrap system "${plist_loc}" ; then
  log_event "❌ Error: Failed to bootstrap service '${subsystem}' from '${plist_loc}'."
  exit 1
fi

# 3. Force it to run RIGHT NOW (Kickstart)
log_event "Kickstarting service '${subsystem}'..."
if ! sudo launchctl kickstart -k system/${subsystem} ; then
  log_event "❌ Error: Failed to kickstart service '${subsystem}'."
  exit 1
fi

log_event "✅ Done."
